meta {
  name: 3_Get_an_album_from_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{albums_path_root}}/{{albumId}}
  body: none
  auth: inherit
}

script:pre-request {
  // --- Showcase Strategy: Smart ID Selection ---
  
  // Probl√®me : L'album cr√©√© √† l'√©tape 2 (ID 101) n'est pas persist√© par JSONPlaceholder.
  // Solution : On utilise l'ID r√©el ('existingAlbumId') captur√© √† l'√©tape 1 pour garantir un test vert.
  
  let targetId = bru.getVar("existingAlbumId");

  // --- Self-Healing ---
  // Si le test est lanc√© isol√©ment (sans l'√©tape 1), on force l'ID 1.
  if (!targetId) {
    targetId = 1;
    console.log("[Showcase Info] No existingAlbumId found. Defaulting to Album ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real album with ID: ${targetId}`);
  }

  // On injecte la variable pour l'URL
  bru.setVar("albumId", targetId);
}

tests {
  // 1. Validation de Succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de Coh√©rence
  test("Returned ID matches requested ID", function() {
    const requestedId = parseInt(bru.getVar("albumId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de Schema
  test("Album has valid structure", function() {
    const album = res.getBody();
    
    expect(album).to.have.property('title').that.is.a('string');
    expect(album).to.have.property('userId').that.is.a('number');
    
    // V√©rification que le titre n'est pas vide
    expect(album.title.length).to.be.greaterThan(0);
  });
  
  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}

docs {
  # üß™ Scenario: Single Album Retrieval (Mock Handling)

  This request demonstrates how to handle **Non-Persistent Mock APIs** in an automated test suite.

  ## üß† Technical Highlight: The "Phantom Resource" Problem
  In a standard CRUD flow, we would fetch the resource created in the previous step. However, **JsonPlaceholder** does not persist new resources:
  * **The Issue**: Fetching the Album ID returned by the creation step (e.g., `101`) would return a `404`.
  * **The Solution**: The script intelligently redirects the request to `existingAlbumId`, a real resource ID captured during the initialization phase.

  ## üõ°Ô∏è Robustness & Self-Healing
  * **Context Awareness**: The script detects if it's running in a full sequence or in isolation.
  * **Fallback Mechanism**: If `existingAlbumId` is undefined, it defaults to `ID: 1` to ensure the test passes and validates the schema, regardless of the execution context.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Data Consistency**: Verifies that the returned object ID matches the requested ID.
  * **Schema Validation**: Checks for the presence and type of critical fields (`title`, `userId`).
}