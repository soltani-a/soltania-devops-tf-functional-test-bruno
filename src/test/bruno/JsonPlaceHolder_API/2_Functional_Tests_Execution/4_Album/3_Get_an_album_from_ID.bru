meta {
  name: 3_Get_an_album_from_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{albums_path_root}}/{{albumId}}
  body: none
  auth: inherit
}

script:pre-request {
  // --- Showcase Strategy: Smart ID Selection ---
  
  // Problème : L'album créé à l'étape 2 (ID 101) n'est pas persisté par JSONPlaceholder.
  // Solution : On utilise l'ID réel ('existingAlbumId') capturé à l'étape 1 pour garantir un test vert.
  
  let targetId = bru.getVar("existingAlbumId");

  // --- Self-Healing ---
  // Si le test est lancé isolément (sans l'étape 1), on force l'ID 1.
  if (!targetId) {
    targetId = 1;
    console.log("[Showcase Info] No existingAlbumId found. Defaulting to Album ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real album with ID: ${targetId}`);
  }

  // On injecte la variable pour l'URL
  bru.setVar("albumId", targetId);
}

tests {
  // 1. Validation de Succès
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de Cohérence
  test("Returned ID matches requested ID", function() {
    const requestedId = parseInt(bru.getVar("albumId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de Schema
  test("Album has valid structure", function() {
    const album = res.getBody();
    
    expect(album).to.have.property('title').that.is.a('string');
    expect(album).to.have.property('userId').that.is.a('number');
    
    // Vérification que le titre n'est pas vide
    expect(album.title.length).to.be.greaterThan(0);
  });
  
  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}