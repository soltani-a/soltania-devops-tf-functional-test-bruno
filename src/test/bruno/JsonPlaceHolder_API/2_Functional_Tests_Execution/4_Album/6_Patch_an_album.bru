meta {
  name: 6_Patch_an_album
  type: http
  seq: 6
}

patch {
  url: {{url}}/{{albums_path_root}}/{{albumId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "title": "{{patchedAlbumTitle}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Partial Update (Status Change) ---
  
  // Sc√©nario : L'album "Infrastructure" est maintenant pr√™t √† √™tre partag√©.
  // On ajoute le tag [PUBLIC] au titre.
  
  // 1. Self-Healing
  if (!bru.getVar("albumId")) bru.setVar("albumId", 1);

  // 2. G√©n√©ration dynamique
  // On garde une structure pro
  const randomVersion = Math.floor(Math.random() * 10);
  
  // Ex: "Infrastructure Audit (v1.4) - [PUBLIC ACCESS]"
  bru.setVar("patchedAlbumTitle", `Infrastructure Audit (v1.${randomVersion}) - [PUBLIC ACCESS]`);
}

tests {
  // 1. Validation de Succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de la Modification
  test("Title is updated to Public Access", function() {
    const expected = bru.getVar("patchedAlbumTitle");
    expect(res.getBody().title).to.equal(expected);
  });

  // 3. Test de NON-R√âGRESSION (Showcase Skill)
  test("User ID is preserved (Data Integrity)", function() {
    // Le PATCH ne doit modifier QUE le titre.
    // L'userId doit √™tre toujours pr√©sent et correct.
    
    // Si on a l'userId en m√©moire, on compare la valeur
    if (bru.getVar("userId")) {
       const expectedUserId = parseInt(bru.getVar("userId"));
       expect(res.getBody().userId).to.equal(expectedUserId);
    } else {
       // Sinon on v√©rifie juste que le champ n'a pas disparu
       expect(res.getBody()).to.have.property('userId');
    }
  });
}

docs {
  # üì¢ Scenario: Asset Publication (Access Control Update)

  This request simulates a governance workflow: changing the visibility of a technical document album from **Private/Draft** to **Public**.

  ## üí° Technical Insight: The "PATCH" Efficiency
  This test highlights the efficiency of `PATCH` for granular updates:
  * **The Action**: We transmit *only* the specific field changing state (`title`).
  * **The Contract**: The server must update this field while strictly preserving all other existing data points (like ownership).

  ## üèóÔ∏è Dynamic Lifecycle Management
  The `pre-request` script acts as a "Publisher":
  1. **Versioning**: Increments the version number (e.g., `v1.4`).
  2. **Tagging**: Appends the `[PUBLIC ACCESS]` marker to the title, signifying the asset is ready for general consumption.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **State Change**: Verifies the title correctly reflects the new "Public" status.
  * **Non-Regression**: Crucially asserts that the **Owner** (`userId`) remains attached to the album, ensuring the partial update didn't inadvertently wipe out related data.
}