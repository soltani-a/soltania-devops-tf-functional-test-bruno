meta {
  name: 5_Update_an_album
  type: http
  seq: 5
}

put {
  url: {{url}}/{{albums_path_root}}/{{albumId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "id": {{albumId}},
    "userId": {{userId}},
    "title": "{{updatedAlbumTitle}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Full Resource Update (PUT) ---
  
  // Sc√©nario : L'album de documentation a √©t√© r√©vis√©.
  // On change le titre pour indiquer qu'il est "FINAL" et valid√© par Soltani-A.
  
  // 1. Self-Healing (S√©curit√©)
  if (!bru.getVar("albumId")) bru.setVar("albumId", 1);
  if (!bru.getVar("userId")) bru.setVar("userId", 1);

  // 2. G√©n√©ration de contenu Pro
  const year = new Date().getFullYear();
  
  // Ex: "Infrastructure Audit 2024 - [FINAL VALIDATION]"
  bru.setVar("updatedAlbumTitle", `Infrastructure Audit ${year} - [FINAL VALIDATION]`);
}

tests {
  // 1. Validation HTTP
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation M√©tier
  test("Title indicates final validation", function() {
    expect(res.getBody().title).to.include("[FINAL VALIDATION]");
  });

  // 3. Validation Technique (PUT Behavior)
  test("Album ownership (userId) is preserved", function() {
    // C'est le pi√®ge du PUT : il ne faut pas perdre le lien avec l'utilisateur
    const expectedUserId = parseInt(bru.getVar("userId"));
    expect(res.getBody().userId).to.equal(expectedUserId);
  });
  
  test("Album ID remains unchanged", function() {
    const targetId = parseInt(bru.getVar("albumId"));
    expect(res.getBody().id).to.equal(targetId);
  });
}

docs {
  # üîÑ Scenario: Documentation Finalization (Full Update)

  This request simulates a document lifecycle event: marking an infrastructure album as **Finalized** and ready for release.

  ## üí° Technical Insight: PUT Semantics (Full Replacement)
  This test demonstrates strict adherence to RESTful standards for `PUT` operations.
  * **The Constraint**: A `PUT` request replaces the resource entirely. Failing to include the `userId` would result in the Album becoming "orphaned" (losing its owner).
  * **The Implementation**: To preserve data integrity, the payload explicitly re-sends the `id` and `userId` alongside the modified title.

  ## ‚ú® Dynamic Content Generation
  The `pre-request` script acts as a "Release Manager":
  * **Versioning**: It appends the current year and the `[FINAL VALIDATION]` tag to the album title, simulating a formal audit approval process.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Business Logic**: Verifies the title now strictly contains the "FINAL VALIDATION" marker.
  * **Data Integrity**: Crucially asserts that the **Foreign Key** (`userId`) and Primary Key (`id`) remain unchanged after the full update.
}