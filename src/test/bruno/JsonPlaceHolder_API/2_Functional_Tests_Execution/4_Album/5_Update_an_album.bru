meta {
  name: 5_Update_an_album
  type: http
  seq: 5
}

put {
  url: {{url}}/{{albums_path_root}}/{{albumId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "id": {{albumId}},
    "userId": {{userId}},
    "title": "{{updatedAlbumTitle}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Full Resource Update (PUT) ---
  
  // Scénario : L'album de documentation a été révisé.
  // On change le titre pour indiquer qu'il est "FINAL" et validé par Soltani-A.
  
  // 1. Self-Healing (Sécurité)
  if (!bru.getVar("albumId")) bru.setVar("albumId", 1);
  if (!bru.getVar("userId")) bru.setVar("userId", 1);

  // 2. Génération de contenu Pro
  const year = new Date().getFullYear();
  
  // Ex: "Infrastructure Audit 2024 - [FINAL VALIDATION]"
  bru.setVar("updatedAlbumTitle", `Infrastructure Audit ${year} - [FINAL VALIDATION]`);
}

tests {
  // 1. Validation HTTP
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation Métier
  test("Title indicates final validation", function() {
    expect(res.getBody().title).to.include("[FINAL VALIDATION]");
  });

  // 3. Validation Technique (PUT Behavior)
  test("Album ownership (userId) is preserved", function() {
    // C'est le piège du PUT : il ne faut pas perdre le lien avec l'utilisateur
    const expectedUserId = parseInt(bru.getVar("userId"));
    expect(res.getBody().userId).to.equal(expectedUserId);
  });
  
  test("Album ID remains unchanged", function() {
    const targetId = parseInt(bru.getVar("albumId"));
    expect(res.getBody().id).to.equal(targetId);
  });
}