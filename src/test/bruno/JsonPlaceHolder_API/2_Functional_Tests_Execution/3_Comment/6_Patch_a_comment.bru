meta {
  name: 6_Patch_a_comment
  type: http
  seq: 6
}

patch {
  url: {{url}}/{{comment_path_root}}/{{commentId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "email": "{{patchedEmail}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Partial Update & Workflow ---
  
  // Sc√©nario : Le ticket est r√©solu. Le Manager QA prend le relais.
  // On ne change QUE l'email, le reste (Body/Name) doit rester intact.
  
  // 1. Self-Healing
  if (!bru.getVar("commentId")) bru.setVar("commentId", 1);

  // 2. G√©n√©ration dynamique (Branding Soltani-A)
  const randomId = Math.floor(Math.random() * 100);
  const email = `qa-manager.${randomId}@soltani-a.ai`;
  
  bru.setVar("patchedEmail", email);
}

tests {
  // 1. Validation de Succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de la Modification
  test("Email is updated to QA Manager", function() {
    const expected = bru.getVar("patchedEmail");
    expect(res.getBody().email).to.equal(expected);
  });

  // 3. Test de NON-R√âGRESSION (Le plus important pour PATCH)
  test("Previous data (Name/Body) is preserved", function() {
    // Si l'√©tape 5 (PUT) a √©t√© jou√©e, le nom contient "[RESOLVED]".
    // Le PATCH ne doit PAS avoir effac√© cela.
    
    const name = res.getBody().name;
    
    // On v√©rifie que le champ existe et n'est pas vide
    expect(name).to.be.a('string');
    expect(name.length).to.be.greaterThan(0);
    
    // Bonus : si on est dans le flux complet, on v√©rifie la valeur
    if (name.includes("RESOLVED")) {
      expect(name).to.include("[RESOLVED]");
    }
  });
}

docs {
  # üîÄ Scenario: QA Handoff (Partial Update)

  This request simulates a workflow transition: the resolved ticket is reassigned to a **QA Manager** for final verification.

  ## üí° Technical Insight: The "PATCH" Contract
  This test verifies the specific behavior of HTTP `PATCH`: **Modification without Replacement**.
  * **The Action**: We send *only* a new `email` address.
  * **The Expectation**: All other fields (specifically the `name` field updated in the previous `PUT` step with the `[RESOLVED]` tag) must remain unchanged.

  ## ‚öôÔ∏è Workflow Logic
  1. **Role Transition**: The `pre-request` script generates a dynamic `qa-manager` identity under the corporate domain (`@soltani-a.ai`).
  2. **State Preservation**: Unlike the previous step where we had to send the whole object, here we test the API's ability to merge the delta.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Update Verification**: Confirms the contact email is updated.
  * **Non-Regression**: Crucially asserts that the `name` field still contains `[RESOLVED]`, proving that the partial update did not inadvertently reset the resource state.
}