meta {
  name: 3_Get_a_comment_from_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{comment_path_root}}/{{commentId}}
  body: none
  auth: inherit
}

script:pre-request {
  // --- Showcase Strategy: Handling Mock API Limitations ---
  
  // Rappel : Le commentaire cr√©√© √† l'√©tape 2 n'est pas persist√©.
  // Pour √©viter une 404, on utilise l'ID r√©el captur√© √† l'√©tape 1.
  
  let targetId = bru.getVar("existingCommentId");

  // --- Self-Healing ---
  // Si l'√©tape 1 n'a pas √©t√© lanc√©e, on cible le Commentaire 1 par s√©curit√©.
  if (!targetId) {
    targetId = 1;
    console.log("[Showcase Info] No existingCommentId found. Defaulting to ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real comment with ID: ${targetId}`);
  }

  // On injecte la variable pour l'URL
  bru.setVar("commentId", targetId);
}

tests {
  // 1. Validation de Succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de Coh√©rence
  test("Returned ID matches requested ID", function() {
    const requestedId = parseInt(bru.getVar("commentId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de Schema & Format
  test("Comment has valid email and body", function() {
    const comment = res.getBody();
    
    expect(comment).to.have.property('name').that.is.a('string');
    expect(comment).to.have.property('body').that.is.a('string');
    
    // Regex pour valider le format email (Showcase Skill)
    // V√©rifie qu'il y a des caract√®res, un @, des caract√®res, un point, des caract√®res.
    expect(comment.email).to.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/);
  });
  
  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}

docs {
  # üß™ Scenario: Specific Comment Retrieval (Mock Handling)

  This request demonstrates how to handle **Mock API Limitations** when testing a retrieval endpoint immediately after a creation.

  ## üß† Technical Highlight: The "Mock Paradox"
  Since **JsonPlaceholder** does not persist data created via `POST`, fetching the ID generated in the previous step (e.g., `501`) would result in a `404 Not Found`.
  * **Strategy**: The `pre-request` script ignores the ID from Step 2 and instead targets `existingCommentId` (a real ID captured during the initialization step).

  ## üõ°Ô∏è Robustness & Self-Healing
  * **Context Awareness**: If the test is run in isolation (meaning `existingCommentId` is undefined), the script automatically defaults to `ID: 1`. This ensures the test remains green regardless of the execution context.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Data Integrity**: Verifies the returned ID matches the requested ID.
  * **Format Validation**: Uses a **Regex Pattern** to strictly validate the email format of the commenter.
}