meta {
  name: 3_Get_a_comment_from_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{comment_path_root}}/{{commentId}}
  body: none
  auth: inherit
}

script:pre-request {
  // --- Showcase Strategy: Handling Mock API Limitations ---
  
  // Rappel : Le commentaire créé à l'étape 2 n'est pas persisté.
  // Pour éviter une 404, on utilise l'ID réel capturé à l'étape 1.
  
  let targetId = bru.getVar("existingCommentId");

  // --- Self-Healing ---
  // Si l'étape 1 n'a pas été lancée, on cible le Commentaire 1 par sécurité.
  if (!targetId) {
    targetId = 1;
    console.log("[Showcase Info] No existingCommentId found. Defaulting to ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real comment with ID: ${targetId}`);
  }

  // On injecte la variable pour l'URL
  bru.setVar("commentId", targetId);
}

tests {
  // 1. Validation de Succès
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de Cohérence
  test("Returned ID matches requested ID", function() {
    const requestedId = parseInt(bru.getVar("commentId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de Schema & Format
  test("Comment has valid email and body", function() {
    const comment = res.getBody();
    
    expect(comment).to.have.property('name').that.is.a('string');
    expect(comment).to.have.property('body').that.is.a('string');
    
    // Regex pour valider le format email (Showcase Skill)
    // Vérifie qu'il y a des caractères, un @, des caractères, un point, des caractères.
    expect(comment.email).to.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/);
  });
  
  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}