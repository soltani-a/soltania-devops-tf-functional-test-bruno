meta {
  name: 5_Update_a_comment
  type: http
  seq: 5
}

put {
  url: {{url}}/{{comment_path_root}}/{{commentId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "id": {{commentId}},
    "postId": {{postId}},
    "name": "{{updatedName}}",
    "email": "{{updatedEmail}}",
    "body": "{{updatedBody}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Full Resource Update (PUT) ---
  
  // Sc√©nario : Le ticket/commentaire a √©t√© trait√©. 
  // L'√©quipe Support met √† jour le statut en "[RESOLVED]".
  
  // 1. Self-Healing (S√©curit√©)
  // On s'assure d'avoir les IDs cibles pour ne pas casser le lien.
  if (!bru.getVar("commentId")) bru.setVar("commentId", 1);
  if (!bru.getVar("postId")) bru.setVar("postId", 1);

  // 2. G√©n√©ration de contenu "Support Technique"
  // On remplace le texte al√©atoire par une r√©ponse pro.
  bru.setVar("updatedName", "[RESOLVED] Performance Issue Fixed");
  bru.setVar("updatedEmail", "support-team@soltani-a.ai");
  bru.setVar("updatedBody", "The deployment pipeline has been optimized. Latency is back to normal levels.");
}

tests {
  // 1. Validation HTTP
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation M√©tier
  test("Comment is marked as RESOLVED", function() {
    expect(res.getBody().name).to.include("[RESOLVED]");
  });

  test("Email is updated to Support Team", function() {
    expect(res.getBody().email).to.equal("support-team@soltani-a.ai");
  });

  // 3. Validation Technique (PUT Behavior)
  test("Foreign Key (postId) is preserved", function() {
    // V√©rification cruciale pour un PUT : on n'a pas cass√© le lien avec le post
    const expectedPostId = parseInt(bru.getVar("postId"));
    expect(res.getBody().postId).to.equal(expectedPostId);
  });
}

docs {
  # üé´ Scenario: Support Ticket Resolution (Full Update)

  This request simulates a "Helpdesk" workflow where a reported issue (comment) is processed and closed by the technical support team.

  ## üí° Technical Insight: Full Resource Replacement (PUT)
  This test validates the strict behavior of the `PUT` method:
  * **The Rule**: A PUT request replaces the *entire* resource state.
  * **The Implementation**: To prevent data loss (orphaning the comment), the payload explicitly re-sends the `postId` and `id` alongside the modified content.

  ## üèóÔ∏è Workflow Simulation
  The `pre-request` script transforms the user's comment into an official response:
  1. **Status Change**: Prepends `[RESOLVED]` to the comment name.
  2. **Ownership Change**: Reassigns the author email to `support-team@soltani-a.ai`.
  3. **Content**: Updates the body with a technical resolution message.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Business Logic**: Confirms the comment is marked as `[RESOLVED]` and attributed to the Support Team.
  * **Data Integrity**: Critical assertion ensuring the **Foreign Key** (`postId`) remains consistent after the update.
}