meta {
  name: 6_Patch_user_title
  type: http
  seq: 6
}

patch {
  url: {{url}}/{{user_path_root}}/{{userId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "name": "{{nameWithTitle}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Data Augmentation ---
  
  // Sc√©nario : Promotion de l'utilisateur. 
  // On ne remplace pas son nom, on l'ENRICHIT avec un titre.
  
  // 1. R√©cup√©ration du nom original (g√©n√©r√© √† l'√©tape 2)
  let originalName = bru.getVar("name");
  
  // Self-healing: Si le nom n'existe pas (test isol√©), on en invente un.
  if (!originalName) {
    originalName = "Anonymous User";
    console.log("[Showcase Info] No original name found. Using default.");
  }

  // 2. S√©lection d'un titre al√©atoire
  const titles = ["- DevOps Lead", "- QA Automation", "- Site Reliability Engineer", "[Staff Engineer]"];
  const randomTitle = titles[Math.floor(Math.random() * titles.length)];

  // 3. Construction de la nouvelle valeur
  const newName = `${originalName} ${randomTitle}`;
  
  // On sauvegarde pour la requ√™te et la v√©rification
  bru.setVar("nameWithTitle", newName);
  bru.setVar("addedTitle", randomTitle); // Utile pour le test
}

tests {
  // 1. Validation de succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation que le nom a bien √©t√© enrichi
  test("Name includes the new professional title", function() {
    const expectedName = bru.getVar("nameWithTitle");
    expect(res.getBody().name).to.equal(expectedName);
  });

  // 3. Validation intelligente (Showcase Skill)
  test("Original name is still present inside the new string", function() {
    // On prouve qu'on n'a pas √©cras√© l'identit√© de l'user, juste modifi√©e.
    // Attention : on r√©cup√®re le 'name' original s'il existe dans les vars
    const originalName = bru.getVar("name");
    if (originalName) {
        expect(res.getBody().name).to.include(originalName);
    }
  });
}

docs {
  # üìà Scenario: Internal Promotion (Data Augmentation)

  This request simulates a career progression event: the user receives a **promotion**. Instead of replacing the user's identity, we **augment** existing data.

  ## üé® Technical Feature: Dynamic String Manipulation
  The `pre-request` script demonstrates how to modify state based on previous context:
  1. **Retrieval**: Fetches the `originalName` generated in Step 2.
  2. **Augmentation**: Appends a random professional title (e.g., *"- DevOps Lead"*, *"[Staff Engineer]"*) to the existing string.
  3. **Injection**: Sends only the modified field via `PATCH`.

  ## üõ°Ô∏è Robustness
  * **Self-Healing**: If the test runs in isolation (no original name in memory), it defaults to "Anonymous User" to prevent concatenation errors.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Data Integrity**: Validates that the new name strictly equals the expected formatted string.
  * **Smart Assertion**: Specifically checks that the **Original Identity** is preserved within the new string (e.g., *"Sophie Martin"* is still inside *"Sophie Martin - DevOps Lead"*).
}