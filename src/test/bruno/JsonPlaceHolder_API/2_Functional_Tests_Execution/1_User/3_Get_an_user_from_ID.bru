meta {
  name: 3_Get_an_user_from_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{user_path_root}}/{{userId}}
  body: none
  auth: inherit
}

settings {
  encodeUrl: true
}

script:pre-request {
  // --- Showcase Strategy: Handling Mock API Limitations ---
  
  // NOTE: JSONPlaceholder ne persiste pas les créations. 
  // L'ID 101 (créé à l'étape précédente) retournerait une 404 ici.
  // Pour garantir un test vert (200 OK), on utilise l'ID récupéré à l'étape 1 
  // (un utilisateur réel entre 1 et 10).
  
  let targetId = bru.getVar("existingUserId");

  // --- Self-Healing (Auto-réparation) ---
  // Si l'étape 1 n'a pas tourné, on force un ID par défaut pour éviter le crash.
  if (!targetId) {
    targetId = 1; 
    console.log("[Showcase Info] No existingUserId found. Defaulting to ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real user with ID: ${targetId}`);
  }

  // On définit la variable {{userId}} utilisée dans l'URL
  bru.setVar("userId", targetId);
}

tests {
  // 1. Validation de la requête
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de la cohérence des données
  test("Returned ID matches requested ID", function() {
    // On s'assure que l'API nous renvoie bien l'user qu'on a demandé
    // (et pas une redirection ou un cache bizarre)
    const requestedId = parseInt(bru.getVar("userId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de structure (Deep Check)
  test("User has critical fields (email, address)", function() {
    const user = res.getBody();
    expect(user).to.have.property('username').that.is.a('string');
    expect(user).to.have.property('email').that.include('@'); // Vérif basique format email
    expect(user.address).to.have.property('city');
  });
  
  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}