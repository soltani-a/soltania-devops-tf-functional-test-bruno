meta {
  name: 5_Update_an_user
  type: http
  seq: 5
}

patch {
  url: {{url}}/{{user_path_root}}/{{userId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "email": "{{newEmail}}",
    "address": {
      "street": "Jalan Pinang",
      "suite": "Level 23, Menara Soltani",
      "city": "Kuala Lumpur",
      "zipcode": "50450",
      "geo": {
        "lat": "3.1516",
        "lng": "101.7123"
      }
    },
    "company": {
      "name": "Soltani-A",
      "catchPhrase": "Innovating DevOps Intelligence",
      "bs": "AI-driven infrastructure automation"
    }
  }
}

script:pre-request {
  // --- Showcase Strategy: Contextual Update ---
  
  // Sc√©nario : L'utilisateur existant vient d'√™tre recrut√©.
  // On va mettre √† jour son Email pro et son adresse (Relocation).
  
  // 1. S√©curit√© (Self-healing)
  // On s'assure qu'on a un ID cible. Sinon, on tape sur le 1 par d√©faut.
  let targetId = bru.getVar("userId");
  if (!targetId) {
    bru.setVar("userId", 1); 
    console.log("[Showcase Info] No userId set. Defaulting to ID 1 for update.");
  }

  // 2. G√©n√©ration dynamique de l'email pro
  // On g√©n√®re un email coh√©rent avec le branding
  const randomId = Math.floor(Math.random() * 1000);
  const proEmail = `employee.${randomId}@soltani-a.ai`;
  
  bru.setVar("newEmail", proEmail);
}

tests {
  // 1. Validation HTTP Standard
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation M√©tier (Business Logic)
  test("User company is now Soltani-A", function() {
    // On v√©rifie que le PATCH a bien modifi√© le champ
    expect(res.getBody().company.name).to.equal("Soltani-A");
  });

  test("User has moved to Kuala Lumpur", function() {
    expect(res.getBody().address.city).to.equal("Kuala Lumpur");
  });

  test("Email domain is updated", function() {
    expect(res.getBody().email).to.include("@soltani-a.ai");
  });
  
  // 3. Validation Technique (PATCH behavior)
  test("Other fields are preserved", function() {
    // C'est un test subtil pour montrer qu'on comprend la diff√©rence entre PUT et PATCH.
    // JSONPlaceholder renvoie l'objet complet. L'ID ne doit pas avoir chang√©.
    const targetId = parseInt(bru.getVar("userId"));
    expect(res.getBody().id).to.equal(targetId);
  });
}

docs {
  # üîÑ Scenario: Corporate Recruitment (Partial Update)
  
  This request simulates a major lifecycle event: an existing user is **recruited** by *Soltania Technology*.
  
  ## üí° Technical Insight: PATCH vs. PUT
  Unlike the previous `PUT` examples (which replace the entire resource), this `PATCH` request demonstrates a **Delta Update**:
  * **Goal**: Update only specific business fields (Email, Address, Company).
  * **Requirement**: Other fields (like `name`, `username`, `phone`) must remain untouched.
  
  ## üèóÔ∏è Dynamic Business Logic
  The `pre-request` script prepares the relocation data:
  1. **Relocation**: Moves the user to the company HQ in **Kuala Lumpur**.
  2. **Onboarding**: Generates a fresh `@soltani-a.ai` professional email address.
  3. **Branding**: Updates the Company Name and Catchphrase.
  
  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Business Logic**: Verifies the user is now officially linked to "Soltani-A" and located in "Kuala Lumpur".
  * **Technical Integrity**: Crucially checks that the **User ID** remains unchanged after the patch operation.
}