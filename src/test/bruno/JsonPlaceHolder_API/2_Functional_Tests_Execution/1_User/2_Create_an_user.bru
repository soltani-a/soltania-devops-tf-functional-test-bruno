meta {
  name: 2_Create_an_user
  type: http
  seq: 2
}

post {
  url: {{url}}/{{user_path_root}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "name": "{{name}}",
    "username": "{{username}}",
    "email": "{{email}}",
    "address": {
      "street": "{{street}}",
      "suite": "{{suite}}",
      "city": "{{city}}",
      "zipcode": "{{zipcode}}",
      "geo": {
        "lat": "{{lat}}",
        "lng": "{{lng}}"
      }
    },
    "phone": "{{phone}}",
    "website": "{{website}}",
    "company": {
      "name": "{{companyName}}",
      "catchPhrase": "{{companyCatchPhrase}}",
      "bs": "{{companyBs}}"
    }
  }
}

script:pre-request {
  // --- 1. GÃ©nÃ©rateurs d'identitÃ© (User Identity) ---
  
  function generateFullName() {
    const firstNames = ["Julie", "Ahmad", "Sophie", "Wei", "Emma", "Ravi"];
    const lastNames = ["Graham", "Bin Ismail", "Smith", "Tan", "Martin", "Subramaniam"];
    
    const randomFirst = firstNames[Math.floor(Math.random() * firstNames.length)];
    const randomLast = lastNames[Math.floor(Math.random() * lastNames.length)];
    return randomFirst + " " + randomLast;
  }

  function generateUserName(fullName) {
    // Nettoyage : espaces -> points, minuscule
    const cleanName = fullName.toLowerCase().replace(/\s+/g, '.');
    const randomSuffix = Math.floor(Math.random() * 1000);
    return `${cleanName}.${randomSuffix}`;
  }

  function generateEmail(username) {
    return `${username}@soltani-a.ai`; // Branding Perso
  }

  // --- 2. GÃ©nÃ©rateurs de Localisation (Malaysian Context) ---

  function generateMalaysianAddress() {
    // Adresse crÃ©dible Ã  Kuala Lumpur (KLCC Area)
    return {
      street: "Jalan Pinang",
      suite: "Level 23, Menara Soltani",
      city: "Kuala Lumpur",
      zipcode: "50450",
      geo: {
        lat: "3.1516",
        lng: "101.7123"
      }
    };
  }

  function generateMalaysianPhone() {
    // Format mobile Malaisien : +60 1x-xxxx xxxx
    const randomPart = Math.floor(Math.random() * 8999999) + 1000000;
    return `+60 12-${randomPart}`; 
  }

  // --- 3. ExÃ©cution et Injection des Variables ---

  const fullName = generateFullName();
  const userName = generateUserName(fullName);
  const email = generateEmail(userName);
  const address = generateMalaysianAddress();
  const phone = generateMalaysianPhone();

  // IdentitÃ©
  bru.setVar("name", fullName);
  bru.setVar("username", userName);
  bru.setVar("email", email);

  // Adresse & Phone
  bru.setVar("street", address.street);
  bru.setVar("suite", address.suite);
  bru.setVar("city", address.city);
  bru.setVar("zipcode", address.zipcode);
  bru.setVar("lat", address.geo.lat);
  bru.setVar("lng", address.geo.lng);
  bru.setVar("phone", phone);

  // Branding Soltani-A (Statique)
  bru.setVar("website", "soltani-a.ai");
  bru.setVar("companyName", "Soltani-A");
  bru.setVar("companyCatchPhrase", "Innovating DevOps Intelligence");
  bru.setVar("companyBs", "AI-driven infrastructure automation");
}

script:post-response {
  // --- Showcase Skill: Chaining ---
  // On rÃ©cupÃ¨re l'ID crÃ©Ã© par l'API pour les tests suivants (ex: PATCH/DELETE)
  
  if (res.body.id) {
    bru.setVar("newUserId", res.body.id);
    console.log(`[Showcase Info] Created new user with ID: ${res.body.id}`);
  }
}

tests {
  test("Status code is 201 Created", function() {
    expect(res.getStatus()).to.equal(201);
  });

  test("Response body matches generated name", function() {
    const sentName = bru.getVar("name");
    expect(res.getBody().name).to.equal(sentName);
  });

  test("Company is correctly branded", function() {
    expect(res.getBody().company.name).to.equal("Soltani-A");
  });
}

docs {
  # ðŸš€ Scenario: Employee Onboarding (Dynamic Generation)
  
  This request simulates the onboarding of a new employee at **Soltania Technology**. Instead of using static JSON, this test leverages JavaScript to generate a unique, realistic profile for every execution.
  
  ## âœ¨ Key Technical Features
  
  ### 1. Dynamic Identity Generation (Pre-Request)
  The script generates a completely random identity to ensure test variety and data uniqueness:
  * **Multicultural Names**: Picks from a diverse list (Julie, Ahmad, Wei, Ravi...).
  * **Consistent Credentials**: Generates a username and corporate email (`@soltani-a.ai`) derived from the full name.
  
  ### 2. Contextual Localization (Malaysia)
  To demonstrate international support, the address logic simulates a location in **Kuala Lumpur**:
  * **Address**: Jalan Pinang, Menara Soltani.
  * **Geo**: Real coordinates for KLCC area.
  * **Phone**: Valid Malaysian mobile format (`+60 1x...`).
  
  ### 3. Corporate Branding
  Hardcoded values enforce the company identity:
  * **Company**: Soltani-A
  * **Catchphrase**: Innovating DevOps Intelligence
  
  ## ðŸ”— Data Chaining
  The `post-response` script captures the **ID** returned by the API (e.g., `101`) and stores it in `newUserId`. This variable allows subsequent tests to interact with this specific "newly created" user.
  
  ## âœ… Quality Gates
  * **Status**: 201 Created.
  * **Data Integrity**: Verifies that the name returned by the API matches the dynamically generated name sent in the request.
  * **Branding Check**: Ensures the company name is correctly recorded.
}