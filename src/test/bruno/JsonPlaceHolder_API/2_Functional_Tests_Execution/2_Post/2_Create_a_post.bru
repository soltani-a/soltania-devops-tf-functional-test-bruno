meta {
  name: 2_Create_a_post
  type: http
  seq: 2
}

post {
  url: {{url}}/{{post_path_root}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "title": "{{postTitle}}",
    "body": "{{postBody}}",
    "userId": {{userId}}
  }
}

script:pre-request {
  // --- Showcase Strategy: Content Generation ---
  
  // 1. Robustesse (Self-healing)
  // Si userId n'est pas d√©fini (test isol√©), on utilise l'ID 1
  if (!bru.getVar("userId")) {
    bru.setVar("userId", 1);
  }

  // 2. G√©n√©ration de contenu "Tech/DevOps"
  // Au lieu de "foo", on g√©n√®re des titres r√©alistes pour un blog technique
  const topics = [
    "Kubernetes Autoscaling Strategies",
    "Terraform State Management",
    "Bruno API Testing Guide",
    "GitHub Actions CI/CD Patterns"
  ];
  
  const randomTopic = topics[Math.floor(Math.random() * topics.length)];
  
  const title = `[Tech Blog] ${randomTopic}`;
  const body = `In this article, we dive deep into ${randomTopic} and how it improves infrastructure efficiency at Soltani-A.`;

  bru.setVar("postTitle", title);
  bru.setVar("postBody", body);
}

script:post-response {
  // --- Showcase Best Practice: Runtime Variables ---
  
  // Correction importante : On utilise setVar et NON setEnvVar.
  // setVar = Gard√© en m√©moire le temps du run (Propre)
  // setEnvVar = √âcrit dans le fichier .bru (Sale, modifie le fichier git)
  
  const newId = res.body.id;
  if(newId) {
      bru.setVar("newPostId", newId);
      console.log(`[Showcase Info] Created Post with ID: ${newId}`);
  }
}

tests {
  // 1. Validation de cr√©ation
  test("Status code is 201 Created", function() {
    expect(res.getStatus()).to.equal(201);
  });

  // 2. Validation du contenu
  test("Title matches generated data", function() {
    const sentTitle = bru.getVar("postTitle");
    expect(res.getBody().title).to.equal(sentTitle);
  });

  // 3. Validation de la relation (Cl√© √©trang√®re)
  test("Post is linked to correct User", function() {
    const expectedUserId = parseInt(bru.getVar("userId"));
    expect(res.getBody().userId).to.equal(expectedUserId);
  });
}

docs {
  # üöÄ Scenario: Tech Blog Publication (Dynamic Content)

  This request simulates the publication of a new article on the **Soltani-A Tech Blog**. It demonstrates the ability to generate context-aware, industry-relevant content dynamically rather than using static placeholders.

  ## ‚ú® Technical Highlights

  ### 1. Dynamic Content Generation
  The `pre-request` script replaces generic "foo/bar" data with realistic DevOps topics:
  * **Topics**: Randomly selects from Kubernetes, Terraform, Bruno, or GitHub Actions.
  * **Context**: Auto-generates a title (`[Tech Blog] ...`) and a matching body summary.

  ### 2. Runtime Variable Scope (Clean Git)
  * **Best Practice**: Uses `bru.setVar` to store the `newPostId` in memory for subsequent tests.
  * **Avoidance**: Deliberately avoids `setEnvVar` to prevent modifying the `environments/*.bru` file, ensuring the repository remains clean and stateless in CI/CD.

  ### 3. Robustness (Self-Healing)
  * Checks if a `userId` is available from previous steps. If run in isolation, defaults to ID 1 to prevent failure.

  ## ‚úÖ Quality Gates
  * **Status**: 201 Created.
  * **Data Integrity**: Verifies the API response matches the dynamically generated title.
  * **Relational Integrity**: Confirms the post is correctly linked to the author (`userId`).
}