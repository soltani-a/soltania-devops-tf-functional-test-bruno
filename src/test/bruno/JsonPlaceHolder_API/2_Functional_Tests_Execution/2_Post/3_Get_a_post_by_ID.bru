meta {
  name: 3_Get_a_post_by_ID
  type: http
  seq: 3
}

get {
  url: {{url}}/{{post_path_root}}/{{postId}}
  body: none
  auth: inherit
}

script:pre-request {
  // --- Showcase Strategy: Handling Mock API Constraints ---
  
  // RAPPEL : JSONPlaceholder ne persiste pas les créations.
  // L'ID 'newPostId' (ex: 101) créé à l'étape précédente n'existe pas vraiment serveur côté.
  // Faire un GET dessus renverrait une 404.
  
  // Pour valider que la lecture fonctionne, on utilise un ID RÉEL récupéré à l'étape 1.
  let targetId = bru.getVar("existingPostId");

  // --- Self-Healing ---
  // Si l'étape 1 n'a pas tourné (test isolé), on prend l'ID 1 par défaut.
  if (!targetId) {
    targetId = 1;
    console.log("[Showcase Info] No existingPostId found. Defaulting to ID 1.");
  } else {
    console.log(`[Showcase Info] Fetching real post with ID: ${targetId}`);
  }

  // On injecte cet ID valide dans la variable {{postId}} de l'URL
  bru.setVar("postId", targetId);
}

tests {
  // 1. Validation de succès
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de cohérence
  test("Returned ID matches requested ID", function() {
    const requestedId = parseInt(bru.getVar("postId"));
    expect(res.getBody().id).to.equal(requestedId);
  });

  // 3. Validation de structure (Schema Check)
  test("Post has valid fields", function() {
    const post = res.getBody();
    expect(post).to.have.property('title').that.is.a('string');
    expect(post).to.have.property('body').that.is.a('string');
    expect(post).to.have.property('userId').that.is.a('number');
  });

  // 4. Performance
  test("Response time < 500ms", function() {
    expect(res.getResponseTime()).to.be.below(500);
  });
}