meta {
  name: 6_Patch_a_post
  type: http
  seq: 6
}

patch {
  url: {{url}}/{{post_path_root}}/{{postId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "title": "{{patchedTitle}}"
  }
}

script:pre-request {
  // --- Showcase Strategy: Partial Update (PATCH) ---
  
  // Sc√©nario : L'article a √©t√© approuv√© (√©tape 5).
  // Maintenant, on ajoute juste le num√©ro de version (Release) au titre.
  
  // 1. Self-Healing
  if (!bru.getVar("postId")) bru.setVar("postId", 1);

  // 2. G√©n√©ration dynamique (Versioning)
  const major = Math.floor(Math.random() * 5) + 1;
  const minor = Math.floor(Math.random() * 10);
  
  // Ex: "[v3.4] Soltani-A Architecture Review"
  const newTitle = `[v${major}.${minor}] Soltani-A Architecture Review`;
  
  bru.setVar("patchedTitle", newTitle);
}

tests {
  // 1. Validation de succ√®s
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation de la modification
  test("Title is updated with Version Tag", function() {
    const expected = bru.getVar("patchedTitle");
    expect(res.getBody().title).to.equal(expected);
  });

  // 3. Validation de NON-R√âGRESSION (Showcase Skill)
  test("Body content is preserved (NOT deleted)", function() {
    // C'est la diff√©rence cl√© avec PUT. 
    // On n'a pas envoy√© de "body" dans la requ√™te, il doit donc rester tel quel.
    const bodyContent = res.getBody().body;
    
    // On v√©rifie qu'il n'est pas vide ou undefined
    expect(bodyContent).to.be.a('string');
    expect(bodyContent.length).to.be.greaterThan(0);
    
    // Si l'√©tape 5 a couru, le body contient "Soltani-A". 
    // Sinon (test isol√©), il contient le lorem ipsum par d√©faut.
    // Le test passe dans les deux cas tant que le contenu existe.
  });
}

docs {
  # üöÄ Scenario: Article Release & Versioning (Non-Regression)

  This request executes a specific lifecycle event: tagging the approved article with a **Semantic Version Number** for release.

  ## ‚ú® Technical Highlights

  ### 1. Non-Regression Testing (The "PATCH" Contract)
  This test explicitly validates the difference between `PUT` and `PATCH`.
  * **Action**: We send *only* the new `title`.
  * **Validation**: A dedicated test asserts that the existing `body` content (from the previous step) is **preserved** and not wiped out, confirming the API correctly handles partial updates.

  ### 2. Dynamic Versioning
  The `pre-request` script simulates a release management process by generating a random version tag (e.g., `[v3.5]`) and applying it to the content title.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Data Logic**: Confirms the title includes the new version tag.
  * **Safety**: Critical assertion ensuring the article body remains intact after the title update.
}