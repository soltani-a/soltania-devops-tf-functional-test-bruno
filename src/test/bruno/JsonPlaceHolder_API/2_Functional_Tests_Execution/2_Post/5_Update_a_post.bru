meta {
  name: 5_Update_a_post
  type: http
  seq: 5
}

put {
  url: {{url}}/{{post_path_root}}/{{postId}}
  body: json
  auth: inherit
}

headers {
  Content-type: application/json; charset=UTF-8
}

body:json {
  {
    "id": {{postId}},
    "title": "{{updatedTitle}}",
    "body": "{{updatedBody}}",
    "userId": {{userId}}
  }
}

script:pre-request {
  // --- Showcase Strategy: Full Resource Replacement (PUT) ---
  
  // Sc√©nario : L'article a √©t√© relu et valid√©. 
  // On met √† jour le titre et le corps, mais on doit conserver l'ID et le UserID
  // car le PUT √©crase tout ce qu'on ne lui envoie pas.

  // 1. Self-Healing (S√©curit√©)
  // On s'assure d'avoir un PostID et un UserID cibles.
  if (!bru.getVar("postId")) bru.setVar("postId", 1);
  if (!bru.getVar("userId")) bru.setVar("userId", 1);

  // 2. G√©n√©ration de contenu "Mise √† jour"
  // On simule une validation par l'√©quipe Soltani-A
  const randomRef = Math.floor(Math.random() * 9000) + 1000;
  
  bru.setVar("updatedTitle", `[APPROVED] Soltani-A Architecture Review #${randomRef}`);
  bru.setVar("updatedBody", "This infrastructure design has been validated by the Soltani-A DevOps Center of Excellence. Compliance checks passed.");
}

tests {
  // 1. Validation HTTP
  test("Status code is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  // 2. Validation M√©tier
  test("Title is updated with Approval tag", function() {
    expect(res.getBody().title).to.include("[APPROVED]");
  });

  test("Body mentions Soltani-A validation", function() {
    expect(res.getBody().body).to.include("Soltani-A");
  });

  // 3. Validation Technique (PUT Behavior)
  test("UserID is preserved", function() {
    // C'est crucial pour un PUT : v√©rifier qu'on n'a pas cass√© le lien parent
    const expectedUserId = parseInt(bru.getVar("userId"));
    expect(res.getBody().userId).to.equal(expectedUserId);
  });
}

docs {
  # üîÑ Scenario: Editorial Approval (Full Resource Update)

  This request simulates a critical step in the Content Lifecycle: the **Editorial Review**. A draft post is reviewed, validated, and updated with an official "Approved" status.

  ## üí° Technical Insight: PUT Semantics
  This test demonstrates strict adherence to RESTful standards for **PUT** operations (Idempotent Full Replacement):
  * **The Challenge**: Unlike `PATCH`, a `PUT` request replaces the *entire* resource. Omitting fields (like `userId`) would result in data loss or broken foreign keys.
  * **The Implementation**: The request payload explicitly includes the original `id` and `userId` alongside the updated content to preserve data integrity.

  ## ‚ú® Dynamic Content Generation
  The `pre-request` script simulates a corporate validation workflow:
  1. **Audit Trail**: Generates a random reference ID (`#9000+`).
  2. **Branding**: Updates the title with an `[APPROVED]` tag and rewrites the body to reference the *Soltani-A DevOps Center of Excellence*.

  ## ‚úÖ Quality Gates
  * **Status**: 200 OK.
  * **Business Logic**: Verifies the content now reflects the "Approved" status.
  * **Data Integrity**: Crucially asserts that the **Foreign Key** (`userId`) is preserved after the full update, ensuring the post remains linked to its author.
}